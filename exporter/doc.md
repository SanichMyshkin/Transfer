# üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

## üìë –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞](#-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-–ø—Ä–æ–µ–∫—Ç–∞)
  - [üìë –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ](#-–æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ)
  - [üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
  - [üöÄ `main.py`](#-mainpy)
    - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ)
    - [–ò–º–ø–æ—Ä—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#–∏–º–ø–æ—Ä—Ç—ã-–∏-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
    - [–§—É–Ω–∫—Ü–∏—è `main`](#—Ñ—É–Ω–∫—Ü–∏—è-main)
      - [–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã](#–ª–æ–≥–∏–∫–∞-—Ä–∞–±–æ—Ç—ã)
      - [–ü–∞—Ä–∞–º–µ—Ç—Ä—ã](#–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
      - [–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ](#–≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ-–∑–Ω–∞—á–µ–Ω–∏–µ)
    - [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-—Å-–¥—Ä—É–≥–∏–º–∏-–º–æ–¥—É–ª—è–º–∏)
    - [–ö—Ä–∞—Ç–∫–æ](#–∫—Ä–∞—Ç–∫–æ)
  - [üì¶ –ü–∞–ø–∫–∞ `common`](#-–ø–∞–ø–∫–∞-common)
    - [–§–∞–π–ª: `common/config.py`](#—Ñ–∞–π–ª-commonconfigpy)
      - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-1)
      - [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ](#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
      - [–§—É–Ω–∫—Ü–∏–∏](#—Ñ—É–Ω–∫—Ü–∏–∏)
        - [`get_auth()`](#get_auth)
    - [–§–∞–π–ª: `common/logs.py`](#—Ñ–∞–π–ª-commonlogspy)
      - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-2)
      - [–û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-—ç–ª–µ–º–µ–Ω—Ç—ã)
      - [–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
      - [–°–≤—è–∑–∏](#—Å–≤—è–∑–∏)
- [üìÇ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ü–∞–ø–∫–∞ `database`](#-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-–ø–∞–ø–∫–∞-database)
  - [–§–∞–π–ª: `cleanup_query.py`](#—Ñ–∞–π–ª-cleanup_querypy)
    - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-3)
    - [–§—É–Ω–∫—Ü–∏–∏](#—Ñ—É–Ω–∫—Ü–∏–∏-1)
      - [`fetch_cleanup_name()`](#fetch_cleanup_name)
  - [–§–∞–π–ª: `docker_ports_query.py`](#—Ñ–∞–π–ª-docker_ports_querypy)
    - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-4)
    - [–§—É–Ω–∫—Ü–∏–∏](#—Ñ—É–Ω–∫—Ü–∏–∏-2)
      - [`fetch_docker_ports()`](#fetch_docker_ports)
  - [–§–∞–π–ª: `docker_tags_query.py`](#—Ñ–∞–π–ª-docker_tags_querypy)
    - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-5)
    - [–§—É–Ω–∫—Ü–∏–∏](#—Ñ—É–Ω–∫—Ü–∏–∏-3)
      - [`fetch_docker_tags_data()`](#fetch_docker_tags_data)
  - [–§–∞–π–ª: `repository_size_query.py`](#—Ñ–∞–π–ª-repository_size_querypy)
    - [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ-6)
    - [–§—É–Ω–∫—Ü–∏–∏](#—Ñ—É–Ω–∫—Ü–∏–∏-4)
      - [`get_repository_sizes()`](#get_repository_sizes)
      - [`get_repository_data()`](#get_repository_data)
  - [üîó –í–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –≤–Ω—É—Ç—Ä–∏ `database`](#-–≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏-–≤–Ω—É—Ç—Ä–∏-database)
  - [üì¶ –ü–∞–ø–∫–∞ `metrics`](#-–ø–∞–ø–∫–∞-metrics)
  - [–§–∞–π–ª—ã –∏ –∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏](#—Ñ–∞–π–ª—ã-–∏-–∏—Ö-—Ñ—É–Ω–∫—Ü–∏–∏)
    - [1. `blobs_size.py`](#1-blobs_sizepy)
    - [2. `certificates_expired.py`](#2-certificates_expiredpy)
    - [3. `certificates.py`](#3-certificatespy)
    - [4. `cleanup_policy.py`](#4-cleanup_policypy)
    - [5. `docker_ports.py`](#5-docker_portspy)
    - [6. `docker_tags.py`](#6-docker_tagspy)
    - [7. `repo_size.py`](#7-repo_sizepy)
    - [8. `repo_status.py`](#8-repo_statuspy)
    - [9. `tasks.py`](#9-taskspy)
  - [üîó –í–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–æ–¥—É–ª–µ–π](#-–≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏-–º–æ–¥—É–ª–µ–π)

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ common
‚îÇ   ‚îú‚îÄ‚îÄ config.py          # –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (URL, —Ç–æ–∫–µ–Ω—ã, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)
‚îÇ   ‚îî‚îÄ‚îÄ logs.py            # –µ–¥–∏–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ database
‚îÇ   ‚îú‚îÄ‚îÄ cleanup_query.py
‚îÇ   ‚îú‚îÄ‚îÄ docker_ports_query.py
‚îÇ   ‚îú‚îÄ‚îÄ docker_tags_query.py
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ repository_size_query.py
‚îÇ   ‚îî‚îÄ‚îÄ utils
‚îÇ       ‚îú‚îÄ‚îÄ connection.py
‚îÇ       ‚îú‚îÄ‚îÄ jobs_reader.py
‚îÇ       ‚îî‚îÄ‚îÄ query_to_db.py
‚îú‚îÄ‚îÄ metrics
‚îÇ   ‚îú‚îÄ‚îÄ blobs_size.py
‚îÇ   ‚îú‚îÄ‚îÄ certificates_expired.py
‚îÇ   ‚îú‚îÄ‚îÄ certificates.py
‚îÇ   ‚îú‚îÄ‚îÄ cleanup_policy.py
‚îÇ   ‚îú‚îÄ‚îÄ docker_ports.py
‚îÇ   ‚îú‚îÄ‚îÄ docker_tags.py
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ repo_size.py
‚îÇ   ‚îú‚îÄ‚îÄ repo_status.py
‚îÇ   ‚îú‚îÄ‚îÄ tasks.py
‚îÇ   ‚îî‚îÄ‚îÄ utils
‚îÇ       ‚îú‚îÄ‚îÄ api_gitlab.py
‚îÇ       ‚îú‚îÄ‚îÄ api.py
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ test
‚îÇ   ‚îú‚îÄ‚îÄ test_docker_tags.py
‚îÇ   ‚îú‚îÄ‚îÄ test_sync_cert.py
‚îÇ   ‚îî‚îÄ‚îÄ test_task.py
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ main.py                 # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ makefile
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ requirements.txt
```

---

## üöÄ `main.py`

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–§–∞–π–ª **`main.py`** ‚Äî —ç—Ç–æ **—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞** –ø—Ä–æ–µ–∫—Ç–∞.  
–ó–∞–¥–∞—á–∏:
- –∑–∞–ø—É—Å–∫ HTTP-—Å–µ—Ä–≤–µ—Ä–∞ Prometheus (–ø–æ—Ä—Ç `8000`),  
- –ø–µ—Ä–≤–∏—á–Ω—ã–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫,  
- –∑–∞–ø—É—Å–∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º —Å–±–æ—Ä–æ–º –º–µ—Ç—Ä–∏–∫ (–ø–æ —Ä–∞–∑–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º),  
- –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.

---

### –ò–º–ø–æ—Ä—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**  
  - `time` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏.

- **–õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏**
  - `common.logs.logging` ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.  
  - `common.config`  
    - `get_auth()` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(username, password)` –¥–ª—è Nexus.  
    - `NEXUS_API_URL`, `LAUNCH_INTERVAL`, `REPO_METRICS_INTERVAL` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.  
  - `metrics.*`  
    - `repo_status.fetch_repositories_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.  
    - `repo_size.fetch_repository_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.  
    - `blobs_size.fetch_blob_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –±–ª–æ–±–æ–≤.  
    - `docker_tags.fetch_docker_tags_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ Docker-—Ç–µ–≥–æ–≤.  
    - `tasks.fetch_task_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–¥–∞—á.  
    - `tasks.fetch_all_blob_and_repo_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á.  
    - `tasks.fetch_custom_policy_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫.  
    - `cleanup_policy.fetch_cleanup_policy_usage` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª–∏—Ç–∏–∫ –æ—á–∏—Å—Ç–∫–∏.  
    - `certificates_expired.fetch_cert_lifetime_metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.  

- **–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**
  - `prometheus_client.start_http_server` ‚Äî –∑–∞–ø—É—Å–∫ HTTP-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è Prometheus.  

---

### –§—É–Ω–∫—Ü–∏—è `main`

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1. **–ó–∞–ø—É—Å–∫ HTTP-—Å–µ—Ä–≤–µ—Ä–∞ Prometheus**  
   –ú–µ—Ç—Ä–∏–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ `http://localhost:8000`.  

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**  
   ```python
   auth = get_auth()
   ```
   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Nexus API.  

3. **–ü–µ—Ä–≤–∏—á–Ω—ã–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫**  
   - —Å—Ç–∞—Ç—É—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤,  
   - –ø–æ–ª–∏—Ç–∏–∫–∏ –æ—á–∏—Å—Ç–∫–∏,  
   - —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã,  
   - –ø–æ–≤–∏—Å—à–∏–µ –∑–∞–¥–∞—á–∏,  
   - (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Docker-–ø–æ—Ä—Ç—ã.  

   –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã Prometheus —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏–ª –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.  

4. **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª**  
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª `REPO_METRICS_INTERVAL` –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç—è–∂—ë–ª—ã–µ –º–µ—Ç—Ä–∏–∫–∏.  
   - –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç "–ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ" –º–µ—Ç—Ä–∏–∫–∏ (–±–ª–æ–±—ã, —Ç–µ–≥–∏, –∑–∞–¥–∞—á–∏).  
   - –ñ–¥—ë—Ç `LAUNCH_INTERVAL` —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å.  

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
–§—É–Ω–∫—Ü–∏—è –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.  

#### –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
–§—É–Ω–∫—Ü–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ‚Äî —ç—Ç–æ –≤–µ—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–º —Å–±–æ—Ä–æ–º –º–µ—Ç—Ä–∏–∫.  

---

### –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

```mermaid
flowchart TD
    A[main.py] --> B[common.config]
    A --> C[common.logs]
    A --> D[metrics.repo_status]
    A --> E[metrics.repo_size]
    A --> F[metrics.blobs_size]
    A --> G[metrics.docker_tags]
    A --> H[metrics.tasks]
    A --> I[metrics.cleanup_policy]
    A --> J[metrics.certificates_expired]

    B -->|NEXUS_API_URL, get_auth, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã| A
    C -->|logging| A
```

- **`common.config`** ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.  
- **`common.logs`** ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π.  
- **`metrics.*`** ‚Üí —Å–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø –º–µ—Ç—Ä–∏–∫.  

---

### –ö—Ä–∞—Ç–∫–æ
- `main.py` ‚Äî —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –º–æ–¥—É–ª—å.  
- –ó–∞–ø—É—Å–∫–∞–µ—Ç Prometheus-—Å–µ—Ä–≤–µ—Ä.  
- –û—Ä–≥–∞–Ω–∏–∑—É–µ—Ç –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.  
- –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ `common.config` –∏ `common.logs`.  

---

## üì¶ –ü–∞–ø–∫–∞ `common`

### –§–∞–π–ª: `common/config.py`

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–§–∞–π–ª —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ **–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞**, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ `.env`.  
–ü–æ–∑–≤–æ–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Nexus, GitLab, –ë–î –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –∑–∞–ø—É—Å–∫–∞ –º–µ—Ç—Ä–∏–∫.

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

- **Nexus**
  - `NEXUS_API_URL` ‚Äî –∞–¥—Ä–µ—Å Nexus API.  
  - `NEXUS_USERNAME` ‚Äî –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Nexus.  
  - `NEXUS_PASSWORD` ‚Äî –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Nexus.  

- **GitLab**
  - `GITLAB_URL` ‚Äî –∞–¥—Ä–µ—Å GitLab (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `https://gitlab.ru`).  
  - `GITLAB_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –∫ API GitLab.  
  - `GITLAB_BRANCH` ‚Äî –≤–µ—Ç–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `main`).  

- **–ü—Ä–æ—á–µ–µ**
  - `DATABASE_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.  
  - `REPO_METRICS_INTERVAL` ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö) –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç—è–∂—ë–ª—ã—Ö –º–µ—Ç—Ä–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `1800`).  
  - `LAUNCH_INTERVAL` ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö) –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `300`).  

#### –§—É–Ω–∫—Ü–∏–∏

##### `get_auth()`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ `(NEXUS_USERNAME, NEXUS_PASSWORD)` –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Nexus API.  
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: –Ω–µ—Ç.  
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: `tuple[str, str]`.  
- **–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: –≤ `main.py` –∏ –º–æ–¥—É–ª—è—Ö `metrics/*`.  

---

### –§–∞–π–ª: `common/logs.py`

#### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ï–¥–∏–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.  
–ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.  

#### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã

- **`logging.basicConfig(...)`**  
  –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç:
  - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî `INFO`.  
  - –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤: `–í–†–ï–ú–Ø - –£–†–û–í–ï–ù–¨ - –ú–û–î–£–õ–¨ - –°–û–û–ë–©–ï–ù–ò–ï`.  
  - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî `StreamHandler`.  

- **`logger = logging.getLogger(current_file)`**  
  –°–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ —Ç–µ–∫—É—â–µ–º—É —Ñ–∞–π–ª—É.  

#### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```python
from common.logs import logger

logger.info("–ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫")
logger.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
```

#### –°–≤—è–∑–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.  
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –ª–æ–≥–æ–≤.  

---

# üìÇ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ü–∞–ø–∫–∞ `database`

–ú–æ–¥—É–ª–∏ —ç—Ç–æ–π –ø–∞–ø–∫–∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è **—Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö Nexus**.  
–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã SQL-–∑–∞–ø—Ä–æ—Å—ã –∏ —É—Ç–∏–ª–∏—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö, –ø–æ–ª–∏—Ç–∏–∫–∞—Ö –æ—á–∏—Å—Ç–∫–∏, Docker-—Ç–µ–≥–∞—Ö –∏ –ø—Ä.

---

## –§–∞–π–ª: `cleanup_query.py`

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–º—ë–Ω –ø–æ–ª–∏—Ç–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –∏–∑ –ë–î.

### –§—É–Ω–∫—Ü–∏–∏

#### `fetch_cleanup_name()`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–∏—Ç–∏–∫ –æ—á–∏—Å—Ç–∫–∏ (`cleanup_policy`).  
- **SQL-–∑–∞–ø—Ä–æ—Å**:
  ```sql
  SELECT name FROM cleanup_policy;
  ```
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: –Ω–µ—Ç.  
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫).  
- **–°–≤—è–∑–∏**:  
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `database.utils.query_to_db.fetch_data` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.  

---

## –§–∞–π–ª: `docker_ports_query.py`

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ **Docker-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö**: –∏–º—è, HTTP-–ø–æ—Ä—Ç, —É–¥–∞–ª—ë–Ω–Ω—ã–π URL.

### –§—É–Ω–∫—Ü–∏–∏

#### `fetch_docker_ports()`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
  1. –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ `name` –∏ `attributes` —É –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ —Å —Ç–∏–ø–æ–º `docker-hosted` –∏–ª–∏ `docker-proxy`.  
  2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–∞—Ä—Å–∏—Ç JSON `attributes`.  
  3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç:
     - `httpPort` (–Ω–æ–º–µ—Ä HTTP-–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å),  
     - `remoteUrl` (—É–¥–∞–ª—ë–Ω–Ω—ã–π –∞–¥—Ä–µ—Å, –µ—Å–ª–∏ —ç—Ç–æ proxy).  
  4. –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é.
- **SQL-–∑–∞–ø—Ä–æ—Å**:
  ```sql
  SELECT r.name, r.attributes
  FROM repository r
  WHERE r.recipe_name IN ('docker-hosted', 'docker-proxy');
  ```
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: –Ω–µ—Ç.  
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Ñ–æ—Ä–º–∞—Ç–∞:  
  ```python
  {
    "repository_name": str,
    "http_port": int | None,
    "remote_url": str | None
  }
  ```
- **–°–≤—è–∑–∏**:
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `database.utils.query_to_db.fetch_data` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∫,  
  - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (`common.logs.logging`) –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.  

---

## –§–∞–π–ª: `docker_tags_query.py`

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Docker-—Ç–µ–≥–∞—Ö, –∏—Ö –≤–µ—Ä—Å–∏—è—Ö –∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º.

### –§—É–Ω–∫—Ü–∏–∏

#### `fetch_docker_tags_data()`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π —Ç–∞–±–ª–∏—Ü—ã `docker_component`, `docker_content_repository` –∏ `repository`, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ Docker-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –∏—Ö —Å–≤—è–∑—å —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏.  
- **SQL-–∑–∞–ø—Ä–æ—Å**:
  ```sql
  SELECT
      dc.name,
      dc.version,
      r.name,
      r.recipe_name,
      (r.attributes::jsonb -> 'storage' ->> 'blobStoreName')
  FROM docker_component dc
  JOIN docker_content_repository dcr ON dc.repository_id = dcr.repository_id
  JOIN repository r ON dcr.config_repository_id = r.id;
  ```
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: –Ω–µ—Ç.  
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ (–∫–æ—Ä—Ç–µ–∂–µ–π), –∫–∞–∂–¥–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç:
  1. –∏–º—è Docker-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞,  
  2. –µ–≥–æ –≤–µ—Ä—Å–∏—é,  
  3. –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è,  
  4. —Ç–∏–ø —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (`recipe_name`),  
  5. –∏–º—è blob-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞.  
- **–°–≤—è–∑–∏**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `database.utils.query_to_db.fetch_data`.  

---

## –§–∞–π–ª: `repository_size_query.py`

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—Ä–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

### –§—É–Ω–∫—Ü–∏–∏

#### `get_repository_sizes()`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
  1. –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å –∫ `pg_catalog.pg_tables`, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã, –æ–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞ `_content_repository`.  
  2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–æ–∏—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL-–∑–∞–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é `psycopg2.sql.SQL`.  
  3. –°—á–∏—Ç–∞–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö blob‚Äô–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é.  
  4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏.  
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: –Ω–µ—Ç.  
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å–ª–æ–≤–∞—Ä—å `{ repository_name: size_in_bytes }`.  
- **–°–≤—è–∑–∏**:
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `database.utils.query_to_db.execute_custom` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ —Å –∫—É—Ä—Å–æ—Ä–æ–º,  
  - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `common.logs.logging`.  

#### `get_repository_data()`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:  
  - –∏–º—è,  
  - —Ñ–æ—Ä–º–∞—Ç (`docker`, `maven`, `npm` –∏ —Ç.–ø.),  
  - —Ç–∏–ø (`proxy`, `hosted` –∏ —Ç.–ø.),  
  - blob-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ,  
  - –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏.  
- **SQL-–∑–∞–ø—Ä–æ—Å**:
  ```sql
  SELECT 
      r.name AS repository_name,
      SPLIT_PART(r.recipe_name, '-', 1) AS format,
      SPLIT_PART(r.recipe_name, '-', 2) AS repository_type,
      r.attributes->'storage'->>'blobStoreName' AS blob_store_name,
      COALESCE(r.attributes->'cleanup'->>'policyName', '') AS cleanup_policy
  FROM repository r
  ORDER BY format, repository_type, repository_name;
  ```
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: –Ω–µ—Ç.  
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π:
  ```python
  {
    "repository_name": str,
    "format": str,
    "repository_type": str,
    "blob_store_name": str,
    "cleanup_policy": str
  }
  ```
- **–°–≤—è–∑–∏**:
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `database.utils.query_to_db.fetch_data`.  

---

## üîó –í–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –≤–Ω—É—Ç—Ä–∏ `database`

```mermaid
flowchart TD
    subgraph DB[database]
        A[cleanup_query.py]
        B[docker_ports_query.py]
        C[docker_tags_query.py]
        D[repository_size_query.py]
    end

    subgraph Utils[database/utils]
        U1[query_to_db.py]
    end

    A --> U1
    B --> U1
    C --> U1
    D --> U1

    B -->|logging| L[common.logs]
    D -->|logging| L
```


---

## üì¶ –ü–∞–ø–∫–∞ `metrics`

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–æ–¥—É–ª—è–º –ø–∞–ø–∫–∏ `metrics`, –æ—Ç–≤–µ—á–∞—é—â–∏–º –∑–∞ —Å–±–æ—Ä –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ Prometheus –¥–ª—è Nexus.

---

## –§–∞–π–ª—ã –∏ –∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏

### 1. `blobs_size.py`

* –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è blobstore.
* –ú–µ—Ç—Ä–∏–∫–∏:

  * `nexus_blob_storage_usage` ‚Äî –∑–∞–Ω—è—Ç–æ—Å—Ç—å/—Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ.
  * `nexus_blob_quota` ‚Äî –∫–≤–æ—Ç–∞ blobstore.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `get_blobstores(nexus_url, auth)` ‚Äî –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ blobstore –∏–∑ Nexus API.
  * `get_quota(data)` ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–≤–æ—Ç—É blobstore.
  * `update_metrics(blobstores)` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç Prometheus –º–µ—Ç—Ä–∏–∫–∏.
  * `fetch_blob_metrics(nexus_url, auth)` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫.

### 2. `certificates_expired.py`

* –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –æ —Å—Ä–æ–∫–µ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ SSL –≤ truststore.
* –ú–µ—Ç—Ä–∏–∫–∞: `nexus_cert_days_left`.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `clean_pem(pem)` ‚Äî –æ—á–∏—â–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤.
  * `short_pem(pem)` ‚Äî —Å–æ–∫—Ä–∞—â–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
  * `fetch_cert_lifetime_metrics(nexus_url, auth)` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.

### 3. `certificates.py`

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Å remote URL proxy-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.
* –ú–µ—Ç—Ä–∏–∫–∞: `nexus_cert_url_match`.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `match_level(cert_cn, remote_url)` ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
  * `update_cert_match_metrics(nexus_url, auth)` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.

### 4. `cleanup_policy.py`

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫ –æ—á–∏—Å—Ç–∫–∏.
* –ú–µ—Ç—Ä–∏–∫–∞: `nexus_cleanup_policy_used`.
* –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `fetch_cleanup_policy_usage(api_url, auth)`.

### 5. `docker_ports.py`

* –ú–µ—Ç—Ä–∏–∫–∏ Docker-–ø–æ—Ä—Ç–æ–≤ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤.
* –ú–µ—Ç—Ä–∏–∫–∏: `docker_repository_port_info`, `docker_port_status`.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `extract_ports(file_text)` ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ—Ä—Ç—ã –∏–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤.
  * `map_ports_to_endpoints(nginx_conf)` ‚Äî —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Ä—Ç—ã —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏.
  * `get_docker_repositories(nexus_url, auth)` ‚Äî –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ Docker-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.
  * `fetch_docker_ports(nexus_url, auth)` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫.

### 6. `docker_tags.py`

* –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Docker-–æ–±—Ä–∞–∑–∞—Ö –∏ –∏—Ö —Ç–µ–≥–∞—Ö.
* –ú–µ—Ç—Ä–∏–∫–∞: `docker_image_tags_info`.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `process_docker_result(result)` ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±—Ä–∞–∑–∞–º –∏ —Ç–µ–≥–∞–º.
  * `fetch_docker_tags_metrics()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prometheus –º–µ—Ç—Ä–∏–∫.

### 7. `repo_size.py`

* –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –∑–∞–¥–∞—á –ø–æ blobStore.
* –ú–µ—Ç—Ä–∏–∫–∞: `nexus_repo_size`.
* –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `fetch_repository_metrics()`.

### 8. `repo_status.py`

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ proxy-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –∏—Ö remote URL.
* –ú–µ—Ç—Ä–∏–∫–∏: `nexus_proxy_repo_status`, `nexus_repo_count`.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `check_url_status(name, url, auth, check_dns)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ URL.
  * `fetch_status(repo, auth)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
  * `fetch_repositories_metrics(nexus_url, auth)` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫.

### 9. `tasks.py`

* –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–¥–∞—á Nexus –∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫.
* –ú–µ—Ç—Ä–∏–∫–∏: `nexus_task_info`, `nexus_task_match_info`, `nexus_custom_policy_expired`.
* –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

  * `fetch_task_metrics(NEXUS_API_URL, auth)` ‚Äî —Å–±–æ—Ä –≤—Å–µ—Ö –∑–∞–¥–∞—á.
  * `fetch_all_blob_and_repo_metrics(NEXUS_API_URL, auth)` ‚Äî —Å–±–æ—Ä blob/repo –∑–∞–¥–∞—á.
  * `fetch_custom_policy_metrics(NEXUS_API_URL, auth)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫.

---

## üîó –í–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–æ–¥—É–ª–µ–π

```mermaid
flowchart TD
    subgraph Metrics[metrics]
        BLOB[blobs_size.py]
        CERT_EXP[certificates_expired.py]
        CERT[certificates.py]
        CP[cleanup_policy.py]
        DP[docker_ports.py]
        DT[docker_tags.py]
        RSZ[repo_size.py]
        RST[repo_status.py]
        TASK[tasks.py]
    end

    subgraph Utils[metrics/utils]
        API[api.py]
        GIT[api_gitlab.py]
    end

    subgraph DB[database]
        CU_DB[cleanup_query.py]
        DT_DB[docker_tags_query.py]
        RS_DB[repository_size_query.py]
        JOBS_DB[jobs_reader.py]
    end

    CP --> API
    CP --> CU_DB
    DP --> API
    DP --> GIT
    DT --> API
    DT --> DT_DB
    RSZ --> RS_DB
    RSZ --> JOBS_DB
    RSZ --> GIT
    RST --> API
    TASK --> API
    TASK --> JOBS_DB
    TASK --> GIT

    BLOB --> API
    CERT_EXP --> API
    CERT --> API

    CP -->|logging| L[common.logs]
    DP -->|logging| L
    DT -->|logging| L
    RSZ -->|logging| L
    RST -->|logging| L
    TASK -->|logging| L
    BLOB -->|logging| L
    CERT_EXP -->|logging| L
    CERT -->|logging| L
```

