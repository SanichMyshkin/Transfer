# ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

## ðŸ“‘ ÐžÐ³Ð»Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ

- [ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°](#-Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ-Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°)
  - [ðŸ“‘ ÐžÐ³Ð»Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ](#-Ð¾Ð³Ð»Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ)
  - [ðŸ“‚ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°](#-ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°-Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°)
  - [ðŸš€ `main.py`](#-mainpy)
    - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ)
    - [Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸](#Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹-Ð¸-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸)
    - [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ `main`](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ-main)
      - [Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹](#Ð»Ð¾Ð³Ð¸ÐºÐ°-Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹)
      - [ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹](#Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹)
      - [Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼Ð¾Ðµ-Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ)
    - [Ð’Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼Ð¸](#Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ-Ñ-Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸-Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼Ð¸)
    - [ÐšÑ€Ð°Ñ‚ÐºÐ¾](#ÐºÑ€Ð°Ñ‚ÐºÐ¾)
  - [ðŸ“¦ ÐŸÐ°Ð¿ÐºÐ° `common`](#-Ð¿Ð°Ð¿ÐºÐ°-common)
    - [Ð¤Ð°Ð¹Ð»: `common/config.py`](#Ñ„Ð°Ð¹Ð»-commonconfigpy)
      - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ-1)
      - [ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ](#Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ)
      - [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸)
        - [`get_auth()`](#get_auth)
    - [Ð¤Ð°Ð¹Ð»: `common/logs.py`](#Ñ„Ð°Ð¹Ð»-commonlogspy)
      - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ-2)
      - [ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹](#Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ-ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹)
      - [ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ](#Ð¿Ñ€Ð¸Ð¼ÐµÑ€-Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ)
      - [Ð¡Ð²ÑÐ·Ð¸](#ÑÐ²ÑÐ·Ð¸)
- [ðŸ“‚ Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: ÐŸÐ°Ð¿ÐºÐ° `database`](#-Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ-Ð¿Ð°Ð¿ÐºÐ°-database)
  - [Ð¤Ð°Ð¹Ð»: `cleanup_query.py`](#Ñ„Ð°Ð¹Ð»-cleanup_querypy)
    - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ-3)
    - [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸-1)
      - [`fetch_cleanup_name()`](#fetch_cleanup_name)
  - [Ð¤Ð°Ð¹Ð»: `docker_ports_query.py`](#Ñ„Ð°Ð¹Ð»-docker_ports_querypy)
    - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ-4)
    - [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸-2)
      - [`fetch_docker_ports()`](#fetch_docker_ports)
  - [Ð¤Ð°Ð¹Ð»: `docker_tags_query.py`](#Ñ„Ð°Ð¹Ð»-docker_tags_querypy)
    - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ-5)
    - [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸-3)
      - [`fetch_docker_tags_data()`](#fetch_docker_tags_data)
  - [Ð¤Ð°Ð¹Ð»: `repository_size_query.py`](#Ñ„Ð°Ð¹Ð»-repository_size_querypy)
    - [ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ](#Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ-6)
    - [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸-4)
      - [`get_repository_sizes()`](#get_repository_sizes)
      - [`get_repository_data()`](#get_repository_data)
  - [ðŸ”— Ð’Ð·Ð°Ð¸Ð¼Ð¾ÑÐ²ÑÐ·Ð¸ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ `database`](#-Ð²Ð·Ð°Ð¸Ð¼Ð¾ÑÐ²ÑÐ·Ð¸-Ð²Ð½ÑƒÑ‚Ñ€Ð¸-database)
  - [ðŸ“¦ ÐŸÐ°Ð¿ÐºÐ° `metrics`](#-Ð¿Ð°Ð¿ÐºÐ°-metrics)
  - [Ð¤Ð°Ð¹Ð»Ñ‹ Ð¸ Ð¸Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸](#Ñ„Ð°Ð¹Ð»Ñ‹-Ð¸-Ð¸Ñ…-Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸)
    - [1. `blobs_size.py`](#1-blobs_sizepy)
    - [2. `certificates_expired.py`](#2-certificates_expiredpy)
    - [3. `certificates.py`](#3-certificatespy)
    - [4. `cleanup_policy.py`](#4-cleanup_policypy)
    - [5. `docker_ports.py`](#5-docker_portspy)
    - [6. `docker_tags.py`](#6-docker_tagspy)
    - [7. `repo_size.py`](#7-repo_sizepy)
    - [8. `repo_status.py`](#8-repo_statuspy)
    - [9. `tasks.py`](#9-taskspy)
  - [ðŸ”— Ð’Ð·Ð°Ð¸Ð¼Ð¾ÑÐ²ÑÐ·Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹](#-Ð²Ð·Ð°Ð¸Ð¼Ð¾ÑÐ²ÑÐ·Ð¸-Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹)

---

## ðŸ“‚ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

```
.
â”œâ”€â”€ common
â”‚   â”œâ”€â”€ config.py          # ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (URL, Ñ‚Ð¾ÐºÐµÐ½Ñ‹, Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ñ‹)
â”‚   â””â”€â”€ logs.py            # ÐµÐ´Ð¸Ð½Ð¾Ðµ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
â”œâ”€â”€ database
â”‚   â”œâ”€â”€ cleanup_query.py
â”‚   â”œâ”€â”€ docker_ports_query.py
â”‚   â”œâ”€â”€ docker_tags_query.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ repository_size_query.py
â”‚   â””â”€â”€ utils
â”‚       â”œâ”€â”€ connection.py
â”‚       â”œâ”€â”€ jobs_reader.py
â”‚       â””â”€â”€ query_to_db.py
â”œâ”€â”€ metrics
â”‚   â”œâ”€â”€ blobs_size.py
â”‚   â”œâ”€â”€ certificates_expired.py
â”‚   â”œâ”€â”€ certificates.py
â”‚   â”œâ”€â”€ cleanup_policy.py
â”‚   â”œâ”€â”€ docker_ports.py
â”‚   â”œâ”€â”€ docker_tags.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ repo_size.py
â”‚   â”œâ”€â”€ repo_status.py
â”‚   â”œâ”€â”€ tasks.py
â”‚   â””â”€â”€ utils
â”‚       â”œâ”€â”€ api_gitlab.py
â”‚       â”œâ”€â”€ api.py
â”‚       â””â”€â”€ __init__.py
â”œâ”€â”€ test
â”‚   â”œâ”€â”€ test_docker_tags.py
â”‚   â”œâ”€â”€ test_sync_cert.py
â”‚   â””â”€â”€ test_task.py
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ main.py                 # Ñ‚Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
â”œâ”€â”€ makefile
â”œâ”€â”€ README.md
â””â”€â”€ requirements.txt
```

---

## ðŸš€ `main.py`

### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
Ð¤Ð°Ð¹Ð» **`main.py`** â€” ÑÑ‚Ð¾ **Ñ‚Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°** Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.  
Ð—Ð°Ð´Ð°Ñ‡Ð¸:
- Ð·Ð°Ð¿ÑƒÑÐº HTTP-ÑÐµÑ€Ð²ÐµÑ€Ð° Prometheus (Ð¿Ð¾Ñ€Ñ‚ `8000`),  
- Ð¿ÐµÑ€Ð²Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑÐ±Ð¾Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº,  
- Ð·Ð°Ð¿ÑƒÑÐº Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ð³Ð¾ Ñ†Ð¸ÐºÐ»Ð° Ñ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ ÑÐ±Ð¾Ñ€Ð¾Ð¼ Ð¼ÐµÑ‚Ñ€Ð¸Ðº (Ð¿Ð¾ Ñ€Ð°Ð·Ð½Ñ‹Ð¼ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ð°Ð¼),  
- Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°.

---

### Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸

- **Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸**  
  - `time` â€” ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ð°Ð¼Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð¸Ñ‚ÐµÑ€Ð°Ñ†Ð¸ÑÐ¼Ð¸.

- **Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸**
  - `common.logs.logging` â€” Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ.  
  - `common.config`  
    - `get_auth()` â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ `(username, password)` Ð´Ð»Ñ Nexus.  
    - `NEXUS_API_URL`, `LAUNCH_INTERVAL`, `REPO_METRICS_INTERVAL` â€” Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸.  
  - `metrics.*`  
    - `repo_status.fetch_repositories_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ².  
    - `repo_size.fetch_repository_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ².  
    - `blobs_size.fetch_blob_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð±Ð»Ð¾Ð±Ð¾Ð².  
    - `docker_tags.fetch_docker_tags_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Docker-Ñ‚ÐµÐ³Ð¾Ð².  
    - `tasks.fetch_task_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð·Ð°Ð´Ð°Ñ‡.  
    - `tasks.fetch_all_blob_and_repo_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¿Ð¾Ð²Ð¸ÑÑˆÐ¸Ñ… Ð·Ð°Ð´Ð°Ñ‡.  
    - `tasks.fetch_custom_policy_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº.  
    - `cleanup_policy.fetch_cleanup_policy_usage` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸.  
    - `certificates_expired.fetch_cert_lifetime_metrics` â€” Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð².  

- **Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸**
  - `prometheus_client.start_http_server` â€” Ð·Ð°Ð¿ÑƒÑÐº HTTP-ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Prometheus.  

---

### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ `main`

#### Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
1. **Ð—Ð°Ð¿ÑƒÑÐº HTTP-ÑÐµÑ€Ð²ÐµÑ€Ð° Prometheus**  
   ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÑ‚Ð°Ð½Ð¾Ð²ÑÑ‚ÑÑ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð½Ð° `http://localhost:8000`.  

2. **ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸**  
   ```python
   auth = get_auth()
   ```
   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº Nexus API.  

3. **ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑÐ±Ð¾Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº**  
   - ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ²,  
   - Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸,  
   - ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹,  
   - Ð¿Ð¾Ð²Ð¸ÑÑˆÐ¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸,  
   - (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Docker-Ð¿Ð¾Ñ€Ñ‚Ñ‹.  

   Ð­Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ÑÑ ÑÑ€Ð°Ð·Ñƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Prometheus ÑÑ€Ð°Ð·Ñƒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.  

4. **Ð‘ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ð¹ Ñ†Ð¸ÐºÐ»**  
   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» `REPO_METRICS_INTERVAL` Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ñ‚ÑÐ¶Ñ‘Ð»Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸.  
   - Ð’ÑÐµÐ³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ "Ð»ÐµÐ³ÐºÐ¾Ð²ÐµÑÐ½Ñ‹Ðµ" Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ (Ð±Ð»Ð¾Ð±Ñ‹, Ñ‚ÐµÐ³Ð¸, Ð·Ð°Ð´Ð°Ñ‡Ð¸).  
   - Ð–Ð´Ñ‘Ñ‚ `LAUNCH_INTERVAL` ÑÐµÐºÑƒÐ½Ð´ Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ.  

#### ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð².  

#### Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ â€” ÑÑ‚Ð¾ Ð²ÐµÑ‡Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ñ Ñ†Ð¸ÐºÐ»Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ ÑÐ±Ð¾Ñ€Ð¾Ð¼ Ð¼ÐµÑ‚Ñ€Ð¸Ðº.  

---

### Ð’Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼Ð¸

```mermaid
flowchart TD
    A[main.py] --> B[common.config]
    A --> C[common.logs]
    A --> D[metrics.repo_status]
    A --> E[metrics.repo_size]
    A --> F[metrics.blobs_size]
    A --> G[metrics.docker_tags]
    A --> H[metrics.tasks]
    A --> I[metrics.cleanup_policy]
    A --> J[metrics.certificates_expired]

    B -->|NEXUS_API_URL, get_auth, Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ñ‹| A
    C -->|logging| A
```

- **`common.config`** â†’ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ.  
- **`common.logs`** â†’ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹.  
- **`metrics.*`** â†’ ÑÐ±Ð¾Ñ€ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ¿Ð¿ Ð¼ÐµÑ‚Ñ€Ð¸Ðº.  

---

### ÐšÑ€Ð°Ñ‚ÐºÐ¾
- `main.py` â€” ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ.  
- Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Prometheus-ÑÐµÑ€Ð²ÐµÑ€.  
- ÐžÑ€Ð³Ð°Ð½Ð¸Ð·ÑƒÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ð¼ÐµÑ‚Ñ€Ð¸Ðº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ.  
- ÐžÑÐ½Ð¾Ð²Ð°Ð½ Ð½Ð° `common.config` Ð¸ `common.logs`.  

---

## ðŸ“¦ ÐŸÐ°Ð¿ÐºÐ° `common`

### Ð¤Ð°Ð¹Ð»: `common/config.py`

#### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
Ð¤Ð°Ð¹Ð» Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð²ÑÐµ **Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°**, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð´Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ Ð¸Ð· `.env`.  
ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼ Ðº Nexus, GitLab, Ð‘Ð” Ð¸ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ð°Ð¼Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¼ÐµÑ‚Ñ€Ð¸Ðº.

#### ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ

- **Nexus**
  - `NEXUS_API_URL` â€” Ð°Ð´Ñ€ÐµÑ Nexus API.  
  - `NEXUS_USERNAME` â€” Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Nexus.  
  - `NEXUS_PASSWORD` â€” Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Nexus.  

- **GitLab**
  - `GITLAB_URL` â€” Ð°Ð´Ñ€ÐµÑ GitLab (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ `https://gitlab.ru`).  
  - `GITLAB_TOKEN` â€” Ñ‚Ð¾ÐºÐµÐ½ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº API GitLab.  
  - `GITLAB_BRANCH` â€” Ð²ÐµÑ‚ÐºÐ° Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ `main`).  

- **ÐŸÑ€Ð¾Ñ‡ÐµÐµ**
  - `DATABASE_URL` â€” ÑÑ‚Ñ€Ð¾ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ….  
  - `REPO_METRICS_INTERVAL` â€” Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» (Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…) Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚ÑÐ¶Ñ‘Ð»Ñ‹Ñ… Ð¼ÐµÑ‚Ñ€Ð¸Ðº (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ `1800`).  
  - `LAUNCH_INTERVAL` â€” Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» (Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…) Ð´Ð»Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ñ†Ð¸ÐºÐ»Ð° ÑÐ±Ð¾Ñ€Ð° Ð¼ÐµÑ‚Ñ€Ð¸Ðº (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ `300`).  

#### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸

##### `get_auth()`
- **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚**: Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ‚ÐµÐ¶ `(NEXUS_USERNAME, NEXUS_PASSWORD)` Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð² Nexus API.  
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹**: Ð½ÐµÑ‚.  
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: `tuple[str, str]`.  
- **Ð“Ð´Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ**: Ð² `main.py` Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑÑ… `metrics/*`.  

---

### Ð¤Ð°Ð¹Ð»: `common/logs.py`

#### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
Ð•Ð´Ð¸Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ð²ÑÐµÐ³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.  
ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ Ð² ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼ Ð²Ð¸Ð´Ðµ.  

#### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹

- **`logging.basicConfig(...)`**  
  ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚:
  - Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ â€” `INFO`.  
  - Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð»Ð¾Ð³Ð¾Ð²: `Ð’Ð Ð•ÐœÐ¯ - Ð£Ð ÐžÐ’Ð•ÐÐ¬ - ÐœÐžÐ”Ð£Ð›Ð¬ - Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð•`.  
  - ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº â€” `StreamHandler`.  

- **`logger = logging.getLogger(current_file)`**  
  Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ, Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¹ Ðº Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ñ„Ð°Ð¹Ð»Ñƒ.  

#### ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
```python
from common.logs import logger

logger.info("Ð—Ð°Ð¿ÑƒÑÐº ÑÐ±Ð¾Ñ€Ð° Ð¼ÐµÑ‚Ñ€Ð¸Ðº")
logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
```

#### Ð¡Ð²ÑÐ·Ð¸
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð²Ð¾ Ð²ÑÐµÑ… Ð¼Ð¾Ð´ÑƒÐ»ÑÑ… Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.  
- ÐžÐ±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ ÐµÐ´Ð¸Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ Ð»Ð¾Ð³Ð¾Ð².  

---

# ðŸ“‚ Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: ÐŸÐ°Ð¿ÐºÐ° `database`

ÐœÐ¾Ð´ÑƒÐ»Ð¸ ÑÑ‚Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ Ð´Ð»Ñ **Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð±Ð°Ð·Ð¾Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Nexus**.  
Ð—Ð´ÐµÑÑŒ ÑÐ¾Ð±Ñ€Ð°Ð½Ñ‹ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑŽÑ‚ Ð¸Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑÑ…, Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°Ñ… Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸, Docker-Ñ‚ÐµÐ³Ð°Ñ… Ð¸ Ð¿Ñ€.

---

## Ð¤Ð°Ð¹Ð»: `cleanup_query.py`

### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð¸Ð¼Ñ‘Ð½ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¸Ð· Ð‘Ð”.

### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸

#### `fetch_cleanup_name()`
- **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚**: Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¹ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ (`cleanup_policy`).  
- **SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ**:
  ```sql
  SELECT name FROM cleanup_policy;
  ```
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹**: Ð½ÐµÑ‚.  
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑ‚Ñ€Ð¾Ðº (Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº).  
- **Ð¡Ð²ÑÐ·Ð¸**:  
  - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `database.utils.query_to_db.fetch_data` Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°.  

---

## Ð¤Ð°Ð¹Ð»: `docker_ports_query.py`

### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ **Docker-Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑÑ…**: Ð¸Ð¼Ñ, HTTP-Ð¿Ð¾Ñ€Ñ‚, ÑƒÐ´Ð°Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ URL.

### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸

#### `fetch_docker_ports()`
- **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚**:
  1. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€ÐºÐ¸ `name` Ð¸ `attributes` Ñƒ Ð²ÑÐµÑ… Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² Ñ Ñ‚Ð¸Ð¿Ð¾Ð¼ `docker-hosted` Ð¸Ð»Ð¸ `docker-proxy`.  
  2. Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð°Ñ€ÑÐ¸Ñ‚ JSON `attributes`.  
  3. Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚:
     - `httpPort` (Ð½Ð¾Ð¼ÐµÑ€ HTTP-Ð¿Ð¾Ñ€Ñ‚Ð°, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ),  
     - `remoteUrl` (ÑƒÐ´Ð°Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ð°Ð´Ñ€ÐµÑ, ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ proxy).  
  4. Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹ Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑŽ.
- **SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ**:
  ```sql
  SELECT r.name, r.attributes
  FROM repository r
  WHERE r.recipe_name IN ('docker-hosted', 'docker-proxy');
  ```
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹**: Ð½ÐµÑ‚.  
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°:  
  ```python
  {
    "repository_name": str,
    "http_port": int | None,
    "remote_url": str | None
  }
  ```
- **Ð¡Ð²ÑÐ·Ð¸**:
  - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `database.utils.query_to_db.fetch_data` Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ñ€Ð¾Ðº,  
  - Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (`common.logs.logging`) Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹ Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸.  

---

## Ð¤Ð°Ð¹Ð»: `docker_tags_query.py`

### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Docker-Ñ‚ÐµÐ³Ð°Ñ…, Ð¸Ñ… Ð²ÐµÑ€ÑÐ¸ÑÑ… Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐµ Ðº Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑÐ¼.

### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸

#### `fetch_docker_tags_data()`
- **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚**: Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ, Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÑŽÑ‰Ð¸Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ `docker_component`, `docker_content_repository` Ð¸ `repository`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Docker-ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð¸Ñ… ÑÐ²ÑÐ·ÑŒ Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑÐ¼Ð¸.  
- **SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ**:
  ```sql
  SELECT
      dc.name,
      dc.version,
      r.name,
      r.recipe_name,
      (r.attributes::jsonb -> 'storage' ->> 'blobStoreName')
  FROM docker_component dc
  JOIN docker_content_repository dcr ON dc.repository_id = dcr.repository_id
  JOIN repository r ON dcr.config_repository_id = r.id;
  ```
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹**: Ð½ÐµÑ‚.  
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑ‚Ñ€Ð¾Ðº (ÐºÐ¾Ñ€Ñ‚ÐµÐ¶ÐµÐ¹), ÐºÐ°Ð¶Ð´Ð°Ñ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚:
  1. Ð¸Ð¼Ñ Docker-ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°,  
  2. ÐµÐ³Ð¾ Ð²ÐµÑ€ÑÐ¸ÑŽ,  
  3. Ð¸Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ,  
  4. Ñ‚Ð¸Ð¿ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (`recipe_name`),  
  5. Ð¸Ð¼Ñ blob-Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°.  
- **Ð¡Ð²ÑÐ·Ð¸**: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `database.utils.query_to_db.fetch_data`.  

---

## Ð¤Ð°Ð¹Ð»: `repository_size_query.py`

### ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² Ð¸ Ð¸Ñ… ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸.

### Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸

#### `get_repository_sizes()`
- **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚**:
  1. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ðº `pg_catalog.pg_tables`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ð¹Ñ‚Ð¸ Ð²ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹, Ð¾ÐºÐ°Ð½Ñ‡Ð¸Ð²Ð°ÑŽÑ‰Ð¸ÐµÑÑ Ð½Ð° `_content_repository`.  
  2. Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ `psycopg2.sql.SQL`.  
  3. Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð²ÑÐµÑ… blobâ€™Ð¾Ð² Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑŽ.  
  4. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸.  
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹**: Ð½ÐµÑ‚.  
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ `{ repository_name: size_in_bytes }`.  
- **Ð¡Ð²ÑÐ·Ð¸**:
  - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `database.utils.query_to_db.execute_custom` Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ñ ÐºÑƒÑ€ÑÐ¾Ñ€Ð¾Ð¼,  
  - Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· `common.logs.logging`.  

#### `get_repository_data()`
- **Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚**: Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð±Ð°Ð·Ð¾Ð²ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸:  
  - Ð¸Ð¼Ñ,  
  - Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ (`docker`, `maven`, `npm` Ð¸ Ñ‚.Ð¿.),  
  - Ñ‚Ð¸Ð¿ (`proxy`, `hosted` Ð¸ Ñ‚.Ð¿.),  
  - blob-Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ,  
  - Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð½Ð°Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸.  
- **SQL-Ð·Ð°Ð¿Ñ€Ð¾Ñ**:
  ```sql
  SELECT 
      r.name AS repository_name,
      SPLIT_PART(r.recipe_name, '-', 1) AS format,
      SPLIT_PART(r.recipe_name, '-', 2) AS repository_type,
      r.attributes->'storage'->>'blobStoreName' AS blob_store_name,
      COALESCE(r.attributes->'cleanup'->>'policyName', '') AS cleanup_policy
  FROM repository r
  ORDER BY format, repository_type, repository_name;
  ```
- **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹**: Ð½ÐµÑ‚.  
- **Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚**: ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹:
  ```python
  {
    "repository_name": str,
    "format": str,
    "repository_type": str,
    "blob_store_name": str,
    "cleanup_policy": str
  }
  ```
- **Ð¡Ð²ÑÐ·Ð¸**:
  - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `database.utils.query_to_db.fetch_data`.  

---

## ðŸ”— Ð’Ð·Ð°Ð¸Ð¼Ð¾ÑÐ²ÑÐ·Ð¸ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ `database`

```mermaid
flowchart TD
    subgraph DB[database]
        A[cleanup_query.py]
        B[docker_ports_query.py]
        C[docker_tags_query.py]
        D[repository_size_query.py]
    end

    subgraph Utils[database/utils]
        U1[query_to_db.py]
    end

    A --> U1
    B --> U1
    C --> U1
    D --> U1

    B -->|logging| L[common.logs]
    D -->|logging| L
```


---

## ðŸ“¦ ÐŸÐ°Ð¿ÐºÐ° `metrics`

ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼ Ð¿Ð°Ð¿ÐºÐ¸ `metrics`, Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽÑ‰Ð¸Ð¼ Ð·Ð° ÑÐ±Ð¾Ñ€ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸Ðº Prometheus Ð´Ð»Ñ Nexus.

---

## Ð¤Ð°Ð¹Ð»Ñ‹ Ð¸ Ð¸Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸

### 1. `blobs_size.py`

* Ð¡Ð±Ð¾Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ blobstore.
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸:

  * `nexus_blob_storage_usage` â€” Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ/ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾.
  * `nexus_blob_quota` â€” ÐºÐ²Ð¾Ñ‚Ð° blobstore.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `get_blobstores(nexus_url, auth)` â€” Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº blobstore Ð¸Ð· Nexus API.
  * `get_quota(data)` â€” Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ ÐºÐ²Ð¾Ñ‚Ñƒ blobstore.
  * `update_metrics(blobstores)` â€” Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Prometheus Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸.
  * `fetch_blob_metrics(nexus_url, auth)` â€” Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼ÐµÑ‚Ñ€Ð¸Ðº.

### 2. `certificates_expired.py`

* Ð¡Ð±Ð¾Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº Ð¾ ÑÑ€Ð¾ÐºÐµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² SSL Ð² truststore.
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ°: `nexus_cert_days_left`.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `clean_pem(pem)` â€” Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÑ‚ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð¾Ñ‚ Ð»Ð¸ÑˆÐ½Ð¸Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².
  * `short_pem(pem)` â€” ÑÐ¾ÐºÑ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.
  * `fetch_cert_lifetime_metrics(nexus_url, auth)` â€” ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð´Ð½ÐµÐ¹ Ð´Ð¾ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°.

### 3. `certificates.py`

* ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ SSL-ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ñ remote URL proxy-Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ².
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ°: `nexus_cert_url_match`.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `match_level(cert_cn, remote_url)` â€” Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ.
  * `update_cert_match_metrics(nexus_url, auth)` â€” Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¹.

### 4. `cleanup_policy.py`

* ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸.
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ°: `nexus_cleanup_policy_used`.
* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ: `fetch_cleanup_policy_usage(api_url, auth)`.

### 5. `docker_ports.py`

* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Docker-Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² Ð¸ Ð¸Ñ… ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð².
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸: `docker_repository_port_info`, `docker_port_status`.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `extract_ports(file_text)` â€” Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸Ð· ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð².
  * `map_ports_to_endpoints(nginx_conf)` â€” ÑÐ¾Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ñ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ð°Ð¼Ð¸.
  * `get_docker_repositories(nexus_url, auth)` â€” Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº Docker-Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ².
  * `fetch_docker_ports(nexus_url, auth)` â€” Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº.

### 6. `docker_tags.py`

* Ð¡Ð±Ð¾Ñ€ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Docker-Ð¾Ð±Ñ€Ð°Ð·Ð°Ñ… Ð¸ Ð¸Ñ… Ñ‚ÐµÐ³Ð°Ñ….
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ°: `docker_image_tags_info`.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `process_docker_result(result)` â€” Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ð°Ð¼ Ð¸ Ñ‚ÐµÐ³Ð°Ð¼.
  * `fetch_docker_tags_metrics()` â€” Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Prometheus Ð¼ÐµÑ‚Ñ€Ð¸Ðº.

### 7. `repo_size.py`

* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² Ð¸ Ð·Ð°Ð´Ð°Ñ‡ Ð¿Ð¾ blobStore.
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ°: `nexus_repo_size`.
* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ: `fetch_repository_metrics()`.

### 8. `repo_status.py`

* ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² proxy-Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² Ð¸ Ð¸Ñ… remote URL.
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸: `nexus_proxy_repo_status`, `nexus_repo_count`.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `check_url_status(name, url, auth, check_dns)` â€” Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ URL.
  * `fetch_status(repo, auth)` â€” Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ.
  * `fetch_repositories_metrics(nexus_url, auth)` â€” Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ Ð¼ÐµÑ‚Ñ€Ð¸Ðº.

### 9. `tasks.py`

* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð·Ð°Ð´Ð°Ñ‡ Nexus Ð¸ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº.
* ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸: `nexus_task_info`, `nexus_task_match_info`, `nexus_custom_policy_expired`.
* ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:

  * `fetch_task_metrics(NEXUS_API_URL, auth)` â€” ÑÐ±Ð¾Ñ€ Ð²ÑÐµÑ… Ð·Ð°Ð´Ð°Ñ‡.
  * `fetch_all_blob_and_repo_metrics(NEXUS_API_URL, auth)` â€” ÑÐ±Ð¾Ñ€ blob/repo Ð·Ð°Ð´Ð°Ñ‡.
  * `fetch_custom_policy_metrics(NEXUS_API_URL, auth)` â€” Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº.

---

## ðŸ”— Ð’Ð·Ð°Ð¸Ð¼Ð¾ÑÐ²ÑÐ·Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹

```mermaid
flowchart TD
    subgraph Metrics[metrics]
        BLOB[blobs_size.py]
        CERT_EXP[certificates_expired.py]
        CERT[certificates.py]
        CP[cleanup_policy.py]
        DP[docker_ports.py]
        DT[docker_tags.py]
        RSZ[repo_size.py]
        RST[repo_status.py]
        TASK[tasks.py]
    end

    subgraph Utils[metrics/utils]
        API[api.py]
        GIT[api_gitlab.py]
    end

    subgraph DB[database]
        CU_DB[cleanup_query.py]
        DT_DB[docker_tags_query.py]
        RS_DB[repository_size_query.py]
        JOBS_DB[jobs_reader.py]
    end

    CP --> API
    CP --> CU_DB
    DP --> API
    DP --> GIT
    DT --> API
    DT --> DT_DB
    RSZ --> RS_DB
    RSZ --> JOBS_DB
    RSZ --> GIT
    RST --> API
    TASK --> API
    TASK --> JOBS_DB
    TASK --> GIT

    BLOB --> API
    CERT_EXP --> API
    CERT --> API

    CP -->|logging| L[common.logs]
    DP -->|logging| L
    DT -->|logging| L
    RSZ -->|logging| L
    RST -->|logging| L
    TASK -->|logging| L
    BLOB -->|logging| L
    CERT_EXP -->|logging| L
    CERT -->|logging| L
```

